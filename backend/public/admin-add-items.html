<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin: Add Items to Inventory</title>
    <!-- Load wallet module for authentication -->
    <!-- The wallet module will be loaded from the main game page -->
    <!-- This page should be embedded in or accessed from the game domain -->
    <script>
        // Wait for wallet API to be available (loaded from main game page)
        // If not available, show instructions
        window.addEventListener('load', function() {
            if (!window.walletAPIInstance && !window.WalletAPI) {
                const walletSection = document.getElementById('walletSection');
                if (walletSection) {
                    walletSection.innerHTML = `
                        <div class="alert alert-error">
                            <strong>‚ö†Ô∏è Wallet Module Not Loaded</strong>
                            <p>This admin page requires the wallet module to be loaded.</p>
                            <p><strong>Option 1:</strong> Access this page from the main game (the wallet module will be loaded there)</p>
                            <p><strong>Option 2:</strong> Use the API endpoint directly with your API key</p>
                        </div>
                    `;
                }
            }
        });
    </script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 2rem;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            margin-bottom: 2rem;
            color: #333;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .items-container {
            margin-bottom: 1.5rem;
        }
        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 4px;
            align-items: center;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background: #1976D2;
        }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-success {
            background: #4CAF50;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        .btn-danger {
            background: #f44336;
            color: white;
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        .btn-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1.5rem;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-info {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            font-size: 0.9rem;
        }
        code {
            background: rgba(0,0,0,0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÅ Admin: Add Items to Inventory</h1>

        <!-- Wallet Connection Section -->
        <div id="walletSection" class="form-group">
            <label>Admin Wallet:</label>
            <div id="walletStatus" style="padding: 1rem; background: #f9f9f9; border-radius: 4px; margin-bottom: 1rem;">
                <div id="walletNotConnected">
                    <p style="margin-bottom: 0.5rem;">üîí Connect your admin wallet to continue</p>
                    <button type="button" class="btn btn-primary" onclick="connectWallet()">Connect Wallet</button>
                </div>
                <div id="walletConnected" style="display: none;">
                    <p style="margin-bottom: 0.5rem;"><strong>‚úÖ Wallet Connected:</strong> <span id="walletAddress"></span></p>
                    <button type="button" class="btn btn-danger" onclick="disconnectWallet()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Disconnect</button>
                </div>
                <div id="walletError" style="display: none; color: #721c24; margin-top: 0.5rem;">
                    <strong>‚ùå Error:</strong> <span id="walletErrorText"></span>
                </div>
            </div>
        </div>

        <form id="addItemsForm" style="display: none;">
            <div class="form-group">
                <label for="playerAddress">Player Address:</label>
                <input
                    type="text"
                    id="playerAddress"
                    placeholder="0x..."
                    required
                />
            </div>

            <div class="form-group">
                <div class="btn-header">
                    <label>Items to Add:</label>
                    <button type="button" class="btn btn-success" onclick="addItem()">+ Add Item</button>
                </div>
                <div id="itemsContainer" class="items-container">
                    <!-- Items will be added here -->
                </div>
            </div>

            <button type="submit" class="btn btn-primary" id="submitBtn">
                Add Items to Inventory
            </button>
        </form>

        <div id="result"></div>

        <div class="alert alert-info" style="margin-top: 2rem;">
            <strong>‚ö†Ô∏è Security Note:</strong> This page uses server-side authentication. 
            The API key is stored in the backend and not exposed to the browser.
        </div>
    </div>

    <script>
        // Load dapp-kit for wallet connection
        // Note: This requires the wallet-module to be loaded
        let adminAddress = null;
        let connectedAddress = null;

        async function loadAdminAddress() {
            try {
                const response = await fetch('/api/admin/verify-wallet');
                const data = await response.json();
                if (data.success) {
                    adminAddress = data.adminAddress.toLowerCase();
                    console.log('Admin address:', adminAddress);
                }
            } catch (error) {
                console.error('Failed to load admin address:', error);
            }
        }

        async function connectWallet() {
            const errorDiv = document.getElementById('walletError');
            const errorText = document.getElementById('walletErrorText');
            errorDiv.style.display = 'none';

            // Check if wallet API is available
            let walletAPI = window.walletAPIInstance;
            
            // If not available, try to initialize WalletAPI
            if (!walletAPI && window.WalletAPI && typeof window.WalletAPI.initialize === 'function') {
                try {
                    const configResponse = await fetch('/api/config');
                    const config = await configResponse.json();
                    const network = config.network || 'testnet';
                    window.WalletAPI.initialize(network);
                    // Wait a moment for initialization
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    walletAPI = window.walletAPIInstance;
                } catch (error) {
                    console.error('Failed to initialize wallet:', error);
                }
            }

            if (!walletAPI) {
                errorText.textContent = 'Wallet API not loaded. Please access this page from the main game where the wallet module is loaded.';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const result = await walletAPI.connect();
                
                if (result.success) {
                    connectedAddress = result.address.toLowerCase();
                    console.log('Connected wallet:', connectedAddress);
                    console.log('Admin wallet:', adminAddress);

                    // Verify it's the admin wallet
                    if (connectedAddress === adminAddress) {
                        updateWalletUI(true);
                        document.getElementById('addItemsForm').style.display = 'block';
                    } else {
                        errorText.textContent = `Wrong wallet! Connected: ${result.address.substring(0, 10)}... Expected admin wallet: ${adminAddress ? adminAddress.substring(0, 10) + '...' : 'unknown'}.`;
                        errorDiv.style.display = 'block';
                        await walletAPI.disconnect();
                        connectedAddress = null;
                        updateWalletUI(false);
                    }
                } else {
                    errorText.textContent = result.error || 'Failed to connect wallet';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorText.textContent = error.message || 'Error connecting wallet';
                errorDiv.style.display = 'block';
            }
        }

        async function disconnectWallet() {
            const walletAPI = window.walletAPIInstance;
            if (walletAPI && walletAPI.isConnected()) {
                await walletAPI.disconnect();
            }
            connectedAddress = null;
            updateWalletUI(false);
            document.getElementById('addItemsForm').style.display = 'none';
        }

        function updateWalletUI(connected) {
            const notConnected = document.getElementById('walletNotConnected');
            const connected = document.getElementById('walletConnected');
            const addressSpan = document.getElementById('walletAddress');

            if (connected && connectedAddress) {
                notConnected.style.display = 'none';
                connected.style.display = 'block';
                addressSpan.textContent = connectedAddress.substring(0, 10) + '...' + connectedAddress.substring(connectedAddress.length - 8);
            } else {
                notConnected.style.display = 'block';
                connected.style.display = 'none';
            }
        }

        // Check if wallet is already connected on page load
        async function checkWalletOnLoad() {
            await loadAdminAddress();

            // Wait for wallet API to be available (from main game page)
            let attempts = 0;
            const checkWallet = setInterval(() => {
                attempts++;
                
                // Check for wallet API (could be window.walletAPIInstance or window.WalletAPI)
                const walletAPI = window.walletAPIInstance || (window.WalletAPI && typeof window.WalletAPI.initialize === 'function' ? window.WalletAPI : null);
                
                if (walletAPI) {
                    clearInterval(checkWallet);
                    
                    // If WalletAPI needs initialization, do it
                    if (window.WalletAPI && typeof window.WalletAPI.initialize === 'function' && !window.walletAPIInstance) {
                        // Get network from backend
                        fetch('/api/config')
                            .then(res => res.json())
                            .then(config => {
                                const network = config.network || 'testnet';
                                window.WalletAPI.initialize(network);
                                // Wait a bit for initialization
                                setTimeout(() => checkWalletConnection(), 1000);
                            });
                    } else {
                        checkWalletConnection();
                    }
                } else if (attempts > 40) {
                    clearInterval(checkWallet);
                    console.warn('Wallet API not available after 20 seconds');
                    const errorDiv = document.getElementById('walletError');
                    const errorText = document.getElementById('walletErrorText');
                    if (errorDiv && errorText) {
                        errorText.textContent = 'Wallet API not loaded. Please access this page from the main game or ensure wallet-module is loaded.';
                        errorDiv.style.display = 'block';
                    }
                }
            }, 500);
        }

        function checkWalletConnection() {
            const walletAPI = window.walletAPIInstance;
            if (walletAPI && walletAPI.isConnected()) {
                const address = walletAPI.getAddress();
                if (address) {
                    connectedAddress = address.toLowerCase();
                    if (connectedAddress === adminAddress) {
                        updateWalletUI(true);
                        document.getElementById('addItemsForm').style.display = 'block';
                    } else {
                        updateWalletUI(false);
                        const errorDiv = document.getElementById('walletError');
                        const errorText = document.getElementById('walletErrorText');
                        if (errorDiv && errorText) {
                            errorText.textContent = 'Wrong wallet connected. Please disconnect and connect the admin wallet.';
                            errorDiv.style.display = 'block';
                        }
                    }
                }
            }
        }

        const itemTypes = [
            { id: 'extraLives', name: 'Extra Lives', levels: [1, 2, 3] },
            { id: 'forceField', name: 'Force Field', levels: [1, 2, 3] },
            { id: 'orbLevel', name: 'Orb Level', levels: [1, 2, 3] },
            { id: 'slowTime', name: 'Slow Time', levels: [1, 2, 3] },
            { id: 'destroyAll', name: 'Destroy All Enemies', levels: [1] },
            { id: 'bossKillShot', name: 'Boss Kill Shot', levels: [1] },
            { id: 'coinTractorBeam', name: 'Coin Tractor Beam', levels: [1, 2, 3] },
        ];

        let items = [{ itemId: 'extraLives', level: 1, quantity: 1 }];

        function renderItems() {
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const itemType = itemTypes.find(t => t.id === item.itemId);
                const row = document.createElement('div');
                row.className = 'item-row';

                const itemSelect = document.createElement('select');
                itemTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.name;
                    if (type.id === item.itemId) option.selected = true;
                    itemSelect.appendChild(option);
                });
                itemSelect.onchange = (e) => {
                    items[index].itemId = e.target.value;
                    items[index].level = 1; // Reset level when item changes
                    renderItems();
                };

                const levelSelect = document.createElement('select');
                (itemType?.levels || [1, 2, 3]).forEach(level => {
                    const option = document.createElement('option');
                    option.value = level;
                    option.textContent = `Level ${level}`;
                    if (level === item.level) option.selected = true;
                    levelSelect.appendChild(option);
                });
                levelSelect.onchange = (e) => {
                    items[index].level = parseInt(e.target.value);
                };

                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.min = '1';
                quantityInput.value = item.quantity;
                quantityInput.onchange = (e) => {
                    items[index].quantity = parseInt(e.target.value) || 1;
                };

                const removeBtn = items.length > 1 ? document.createElement('button') : null;
                if (removeBtn) {
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-danger';
                    removeBtn.textContent = '‚úï';
                    removeBtn.onclick = () => {
                        items.splice(index, 1);
                        renderItems();
                    };
                }

                row.appendChild(itemSelect);
                row.appendChild(levelSelect);
                row.appendChild(quantityInput);
                if (removeBtn) row.appendChild(removeBtn);
                container.appendChild(row);
            });
        }

        function addItem() {
            items.push({ itemId: 'extraLives', level: 1, quantity: 1 });
            renderItems();
        }

        document.getElementById('addItemsForm').onsubmit = async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const resultDiv = document.getElementById('result');
            const playerAddress = document.getElementById('playerAddress').value;

            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding Items...';
            resultDiv.innerHTML = '';

            try {
                // Verify wallet is still connected and is admin
                if (!connectedAddress || connectedAddress !== adminAddress) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            <strong>‚ùå Error:</strong>
                            <p>Admin wallet not connected. Please connect the admin wallet.</p>
                        </div>
                    `;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Add Items to Inventory';
                    return;
                }

                const response = await fetch('/api/admin/add-items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        playerAddress,
                        items,
                        adminWalletAddress: connectedAddress, // Send for server verification
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ Success!</strong>
                            <p>${data.message}</p>
                            ${data.digest ? `<p style="margin-top: 0.5rem; font-size: 0.9rem;">Transaction: <code>${data.digest}</code></p>` : ''}
                        </div>
                    `;
                    // Reset form
                    document.getElementById('playerAddress').value = '';
                    items = [{ itemId: 'extraLives', level: 1, quantity: 1 }];
                    renderItems();
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            <strong>‚ùå Error:</strong>
                            <p>${data.error || 'Failed to add items'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå Network Error:</strong>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Items to Inventory';
            }
        };

        // Initialize
        renderItems();
        checkWalletOnLoad();
    </script>
</body>
</html>

